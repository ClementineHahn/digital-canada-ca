version: 2
jobs:
  build:
    docker:
      - image: circleci/ruby:2.4
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: "Get Git submodules"
          command: git submodule sync && git submodule update --init

      # Restore bundle cache
      - type: cache-restore
        key: cds-vendor-bundle-{{ checksum "Gemfile.lock" }}

      - run:
          name: "Bundle install"
          command: bundle install --path vendor/bundle

      # Store bundle cache
      - type: cache-save
        key: cds-vendor-bundle-{{ checksum "Gemfile.lock" }}
        paths:
          - vendor/bundle

      - run:
          name: "Compile english"
          command: bundle exec jekyll build --config _config_en.yml --destination ~/cds-website

      - run:
          name: "Compile french"
          command: bundle exec jekyll build --config _config_fr.yml --destination ~/snc-website

      # Save compiled cache
      - run:
          name: "Save SHA to a file"
          command: echo $CIRCLE_SHA1 > .circle-sha
      - save_cache:
          key: cds-project-{{ checksum ".circle-sha" }}
          paths:
            ~/project
      - save_cache:
          key: cds-website-dist-{{ checksum ".circle-sha" }}
          paths:
            ~/cds-website
            ~/snc-website

  test:
    environment:
      NOKOGIRI_USE_SYSTEM_LIBRARIES: true # speeds up installation of html-proofer
    docker:
      - image: circleci/ruby:2.4
    steps:
      # Restore build cache
      - run:
          name: "Save SHA to a file"
          command: echo $CIRCLE_SHA1 > .circle-sha
      - restore_cache:
          keys:
            - cds-project-{{ checksum ".circle-sha" }}

      - run:
          name: "Test English"
          command: |
            bundle exec jekyll build --config _config_en.yml
            bundle exec htmlproofer ./_site --allow-hash-href --check-favicon --check-html --disable-external --file-ignore=/assets/lib/

      - run:
          name: "Test French"
          command: |
            bundle exec jekyll build --config _config_fr.yml
            bundle exec htmlproofer ./_site --allow-hash-href --check-favicon --check-html --disable-external --file-ignore=/assets/lib/

  deploy:
    docker:
      - image: circleci/python
    steps:
      # Install AWS CLI
      - run:
          name: "PIP install awsclii"
          command: |
            pip install awscli --upgrade --user
            export PATH=~/.local/bin:$PATH
            aws configure set preview.cloudfront true
            aws configure set preview.create-invalidation true
            aws --version

      # Restore build cache
      - run:
          name: "Save SHA to a file"
          command: echo $CIRCLE_SHA1 > .circle-sha
      - restore_cache:
          keys:
            - cds-website-dist-{{ checksum ".circle-sha" }}

      - deploy:
          name: "Deploy English"
          command: |
            export PATH=~/.local/bin:$PATH
            aws s3 sync ~/cds-website s3://cds-website-dist/ --delete

      - run:
          name: "Invalidate English cache"
          command: |
            export PATH=~/.local/bin:$PATH
            aws cloudfront create-invalidation --cli-input-json "{\"DistributionId\":\"E3EIUBOL3WTOOO\",\"InvalidationBatch\":{\"Paths\":{\"Quantity\":1,\"Items\":[\"/*\"]},\"CallerReference\":\"$(date +%s)\"}}"

      - deploy:
          name: "Deploy French"
          command: |
            export PATH=~/.local/bin:$PATH
            aws s3 sync ~/snc-website s3://snc-website-dist/ --delete

      - run:
          name: "Invalidate French cache"
          command: |
            export PATH=~/.local/bin:$PATH
            aws cloudfront create-invalidation --cli-input-json "{\"DistributionId\":\"E3FI5UW2E5PBD3\",\"InvalidationBatch\":{\"Paths\":{\"Quantity\":1,\"Items\":[\"/*\"]},\"CallerReference\":\"$(date +%s)\"}}"

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
      - deploy:
          requires:
            - build
            - test
          filters:
            branches:
              only: bilingualize
      - clear_caches:
          requires:
            - build
            - test
            - deploy
